~~~~~~~~~~~~~~~~~
Deploying BuddyUp
~~~~~~~~~~~~~~~~~

Register for a Heroku Account
=============================

Create an SSH key
=================

Run in a terminal::

    $ ssh-keygen -f ~/.ssh/id_rsa

Install Heroku Toolbelt
=======================

See: https://devcenter.heroku.com/articles/heroku-command

Follow the instructions for installing and logging in.

Setting Up An App
=================

Pick a name for the app (e.g. buddyup). The app will be accessible via
app-name.herokuapp.com. Run::

    $ cd <git repository>
    $ heroku create <app name>
    $ git push heroku master
    


Deploy Using Git
================

Run::

    $ cd <git repository>
    $ git push heroku master

This command will upload your repository to Heroku and create a "slug"
on Heroku's servers.

Add Heroku Postgres
===================

Provision Heroku's Postgres addon::

    $ cd <git repository>
    $ heroku addons:add heroku-postgresql:<postgres plan>

Where ``<postgres plan>`` is the name of your desired postgres plan.
Developers should use the ``dev`` plan. Pick from
https://addons.heroku.com/heroku-postgresql.

You will be assigned a database url named something like 
``HEROKU_POSTGRESQL_BLUE_URL``.
To find it, run::

    $ heroku config | grep HEROKU_POSTGRESQL

If multiple variables are present, you accidentally added multiple databases.
Then run something like::

    $ heroku pg:promote HEROKU_POSTGRESQL_BLUE_URL

Replacing "BLUE" with the correct color. Next create the database tables::

    $ heroku run init
    
To drop and recreate the tables, run::

    $ heroku run scripts/reset
    

Amazon S3
=========

Amazon's Simple Storage System is used to store and serve photos.

First sign up for an Amazon account. Go to the
`Security Credentials`_ page. Scroll down to Access Credentials, create a
new access key, and download the key file. This is your only chance to
get the secret key!

Find the AWS Management Console. Create an S3 bucket. It must have a name
that is unique across all Amazon S3 buckets. If price is a concern, use
US Standard for the location. The images will take a negligibly longer time
to load, but Amazon waives the transfer cost because Heroku's US region is
hosted on Amazon's Virginia/US Standard region servers.

.. _Security Credentials: https://console.aws.amazon.com/iam/home?#security_credential

Set Heroku Variables
====================

BuddyUp must be configured through some environmental variables::

    $ heroku config:set BUDDYUP_TYPE=production

The current implementation only allows one admin. Set the admin user name to
a PSU user name, where ``psuuser`` is replaced by the user name::

    $ heroku config:set ADMIN_USER=psuuser

Cookies are protected by a secret key. By default, the key is just "foo", but
it should be set to a more secure value in production. A very safe key can be
generated by hitting random keys::

    $ heroku config:set SECRET_KEY=tVux6MEVRcaa8+ig5i5hFhm8nzubx9NuyrfIZug=

The URL for the help page is determined by an environmental variable,
with a backup page included if no help page is set.::

    $ heroku config:set HELP_URL=http://...

To enable photo support, look in the rootkey.csv file that you downloaded
from Amazon's Security Credentials page. Configure Heroku using::

    $ heroku config:set AWS_ACCESS_KEY_ID=xxx AWS_SECRET_ACCESS_KEY=xxx

Populating Database
===================

There is a script, ``scripts/populate.py``, that inserts items from
``defaults/``. To insert all defaults, run::

    $ heroku run scripts/populate.py -v all

This inserts all default majors and locations. To dump the contents of
a current BuddyUp instance, use ``scripts/dump.py``. For usage, see::

    $ heroku run scripts/dump-defaults.py --help

Mail
====

Mail alerts are not implemented yet.

Initial Log In
==============

When you first log in, you are directed to /setup/profile. Manually go to
``/admin`` (as in http://buddyup.herokuapp.com/admin) and set up courses.